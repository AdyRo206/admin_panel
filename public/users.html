<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utilizatori</title>
</head>
<body>
    <h2>Gestionare Utilizatori</h2>
    <table id="userTableBody">
        <thead>
            <tr>
                <th>Username</th>
                <th>Nume</th>
                <th>Rol</th>
                <th>Status aprobare</th>
                <th>Acțiuni</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        async function fetchUsers() {
            const response = await fetch('http://localhost:5501/users', {
                method: 'GET',
                headers: {
                    'Authorization': localStorage.getItem('authToken'),
                },
            });
    
            const data = await response.json();
            if (data.success) {
                const users = data.users;
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = ''; // Curăță tabelul înainte
    
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td>${user.role}</td>
                        <td>${user.is_approved ? 'Aprobat' : 'Neaprobat'}</td>
                        <td>
                            <button onclick="resetPassword('${user.id}')">Modifică parola</button>
                            <button onclick="toggleApproval('${user.id}', ${user.is_approved})">
                                ${user.is_approved ? 'Dezaprobă' : 'Aprobă'}
                            </button>
                            <button onclick="toggleRole(${user.id}, '${user.role === 'admin' ? 'user' : 'admin'}')">
                                Schimbă rol
                            </button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } else {
                console.error('Eroare la server:', data.error);
            }
        }
    
        async function resetPassword(userId) {
            const pin = prompt("Introdu PIN-ul pentru a continua:");
            if (!pin) {
                alert("PIN-ul este obligatoriu!");
                return;
            }
    
            const newPassword = prompt("Introdu noua parolă:");
            if (!newPassword) {
                alert("Parola este obligatorie!");
                return;
            }
    
            const response = await fetch(`http://localhost:5501/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('authToken'),
                },
                body: JSON.stringify({ userId, pin, newPassword }),
            });
    
            const result = await response.json();
            if (result.success) {
                alert("Parola a fost modificată cu succes!");
            } else {
                alert(result.message || "Eroare la modificarea parolei.");
            }
        }
    
        async function toggleApproval(userId, currentStatus) {
            const confirmation = confirm(`Sigur vrei să ${currentStatus ? 'dezaprobi' : 'aprobi'} acest cont?`);
            if (!confirmation) return;
    
            const response = await fetch(`http://localhost:5501/toggle-approval`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('authToken'),
                },
                body: JSON.stringify({ userId, newStatus: !currentStatus }),
            });
    
            const result = await response.json();
            if (result.success) {
                alert(`Contul a fost ${!currentStatus ? 'aprobat' : 'dezaprobat'} cu succes.`);
                fetchUsers(); // Actualizează lista
            } else {
                alert(result.message || "Eroare la actualizarea statusului.");
            }
        }

        async function toggleRole(userId, newRole) {
    const token = localStorage.getItem('authToken');
    const response = await fetch(`http://localhost:5501/toggleRole/${userId}`, {
        method: 'PUT',
        headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: newRole }),
    });

    const data = await response.json();
    if (data.success) {
        alert(`Rolul utilizatorului a fost schimbat în ${newRole}!`);
        location.reload();  // Reîncarcă pagina pentru a reflecta modificările
    } else {
        console.error('Eroare la schimbarea rolului:', data.error);
    }
}
    
        fetchUsers();
    </script>
</body>
</html>
